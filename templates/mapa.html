<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Mapa de la ISS</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="{{url_for('static',filename='css/mapa.css')}}">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/css/uikit.min.css" />
    <!-- UIkit JS -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.21.13/dist/js/uikit-icons.min.js"></script>
    <!-- include the jQuery and jQuery UI scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-ui-Slider-Pips/1.11.4/jquery-ui-slider-pips.min.js"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='css/slider.css')}}" />
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script src="{{url_for('static',filename='js/ciudades.js')}}"></script>
    <script src="{{url_for('static',filename='js/contador.js')}}"></script>
    

    <!-- plus a jQuery UI theme, here I use "flick" -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">


</head>

<body>
    

    <!-- This is a button toggling the off-canvas  BOTON QUE EXPANDE DESPLEGABLE OPCIONES-->
    <button uk-toggle="target: #my-id" type="button" style="z-index: 1;position: fixed;border-radius: 0.5em;
    top:3em;left: 3em; font-size: 1.5em;padding: 0.5em;cursor: pointer;">
        Ver opciones
    </button>



    <!-- This is the off-canvas  DESPLEGABLE DE OPCIONES-->
    <div id="my-id" uk-offcanvas>


        <div class="uk-offcanvas-bar" style="width: 600px !important;">
        
            <ul style="z-index: 1;float: left; margin-bottom: 2em;">
                <li id="latitud" style="z-index: 1;font-size: 1em;"></li>
                <li id="longitud" style="z-index: 1;font-size: 1em;"></li>
                <li id="contador" style="color: yellow;z-index: 1;">contador</li>
            </ul>

            <button onclick="centrarMapa()" style="z-index: 1;border-radius: 0.5em;width: 80%;
            font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor:pointer ;">Trayectoria IIS en tiempo real</button>
            <button onclick="lista_xml()" style="z-index: 1;border-radius: 0.5em;width: 80%;
            font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor: pointer;">Predicción de Trayectoria y días anteriores</button>
             <button id="borrar_xml"  onclick="borrar_xml()" style="z-index: 1;border-radius: 0.5em;width: 80%;
            font-size: 1.5em;padding: 0.5em;display: block;margin-bottom: 1em;cursor: pointer;display: none;">Borrar puntos predicciones</button>

            <div class="slider-container">
                <div id="sliderHandle">
                    <div id="custom-handle" class="ui-slider-handle"></div>
                </div>
            </div>
            <input id="hideKeyboard" style="position: absolute; left: 0px; top: -20px; z-index: -1;" type="text"
                name="hideKeyboard" readonly="readonly" />
            <input id="caja-buscar" onkeypress="return event.keyCode != 13;" class="uk-input"
                placeholder="busca (Pais,Ciudad,Rio,Lago...)" autocomplete="off" type="text"
                style="width: 80%;margin-top: -1.2em;" name="buscador"
                 hx-get="/obtener_coordenadas_ciudad"
                 hx-target="#ciudad" 
                 hx-trigger="keyup changed delay:1000ms"
                 hx-swap="innerHTML "
                 hx-on::after-request="this.blur()">
                 
            <span id="limpiar" onclick="limpiar_caja()" style=" font-size: 2.6em; 
                 border: solid 1px rgb(151, 149, 149);background-color: darkgray;cursor: pointer;">X</span>
             <!-- siguiente div es zona de inyección hTMX -->    
            <div id="ciudad" style="margin-top:0.3em;width: 85%;"></div>
            
       
         





            <ul uk-accordion="collapsible: true" style="background-color:rgb(60, 61, 61);width: 85%;">
                <li>
                    <a class="uk-accordion-title" style="background-color:rgb(60, 61, 61);padding: 0.5em;width: 85%;border-bottom: 1px solid white" >Tags favoritos</a>
                    <div class="uk-accordion-content" >
                        <div id="SA" class="uk-badge ciudades" style="color:white !important">America del Sur</div>
                            <div id="NA" class="uk-badge ciudades" style="color:white !important">America del Norte</div>
                            <div id="dublin" class="uk-badge ciudades" style="color:white !important">Dublín</div>
                            <div id="londres" class="uk-badge ciudades" style="color:white !important">London</div>
                            <div id="trinidad" class="uk-badge ciudades" style="color:white !important">Trinidad y Tobago</div>
                            <div id="habana" class="uk-badge ciudades" style="color:white !important">La Habana</div>
                            <div id="vancouver" class="uk-badge ciudades" style="color:white !important">Vancouver</div>
                            <div id="madrid" class="uk-badge ciudades" style="color:white !important">Madrid</div>
                            <div id="huelva" class="uk-badge ciudades" style="color:white !important">Huelva</div>
                            <div id="paris" class="uk-badge ciudades" style="color:white !important">París</div>
                            <div id="caracas" class="uk-badge ciudades" style="color:white !important">Caracas</div>
                            <div id="mallorca" class="uk-badge ciudades" style="color:white !important">Mallorca</div>
                                    </div>
                </li>
                <li>
                    <a class="uk-accordion-title" style="background-color:rgb(60, 61, 61);padding: 0.5em;width: 85%;border-bottom: 1px solid white">Consultar días de visibilidad</a>
                    <div class="uk-accordion-content">
                        <form style="width: 80%;">
                          
                           
                                <select id="country"
                                 class="uk-select" 
                                 name="country"
                                 required=""
                                 width="20" 
                                 title="Country"
                                 style="outline: none;"
                                 hx-get="/ciudades"
                                 hx-target="#select-ciudades" 
                                 hx-trigger="change"
                                 hx-swap="innerHTML ">
                                    <option value="">Select Country</option>
                                    <option value="United_States">United States</option>
                                    <option value="Afghanistan">Afghanistan</option><option value="Albania">Albania</option><option value="Algeria">Algeria</option><option value="Angola">Angola</option><option value="Antigua">Antigua</option><option value="Argentina">Argentina</option><option value="Aruba">Aruba</option><option value="Australia">Australia</option><option value="Austria">Austria</option><option value="Bahamas">Bahamas</option><option value="Bahrain">Bahrain</option><option value="Bangladesh">Bangladesh</option><option value="Barbados">Barbados</option><option value="Belarus">Belarus</option><option value="Belgium">Belgium</option><option value="Belize">Belize</option><option value="Bermuda">Bermuda</option><option value="Bolivia">Bolivia</option><option value="Bonaire">Bonaire</option><option value="Bosnia">Bosnia</option><option value="Botswana">Botswana</option><option value="Brazil">Brazil</option><option value="Brunei">Brunei</option><option value="Bulgaria">Bulgaria</option><option value="Cameroon">Cameroon</option><option value="Canada">Canada</option><option value="Chile">Chile</option><option value="China">China</option><option value="Colombia">Colombia</option><option value="Comoros">Comoros</option><option value="Costa_Rica">Costa Rica</option><option value="Croatia">Croatia</option><option value="Cuba">Cuba</option><option value="Curacao">Curacao</option><option value="Cyprus">Cyprus</option><option value="Czech_Republic">Czech Republic</option><option value="Denmark">Denmark</option><option value="Dominica">Dominica</option><option value="Dominican_Republic">Dominican Republic</option><option value="Ecuador">Ecuador</option><option value="Egypt">Egypt</option><option value="El_Salvador">El Salvador</option><option value="Estonia">Estonia</option><option value="Ethiopia">Ethiopia</option><option value="Falkland_Islands">Falkland Islands</option><option value="Fiji">Fiji</option><option value="Finland">Finland</option><option value="France">France</option><option value="French_Guiana">French Guiana</option><option value="Gabon">Gabon</option><option value="Gambia">Gambia</option><option value="Georgia">Georgia</option><option value="Germany">Germany</option><option value="Ghana">Ghana</option><option value="Greece">Greece</option><option value="Grenada">Grenada</option><option value="Guadeloupe">Guadeloupe</option><option value="Guatemala">Guatemala</option><option value="Guyana">Guyana</option><option value="Haiti">Haiti</option><option value="Honduras">Honduras</option><option value="Hong_Kong">Hong Kong</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="India">India</option><option value="Indonesia">Indonesia</option><option value="Iran">Iran</option><option value="Iraq">Iraq</option><option value="Ireland">Ireland</option><option value="Israel">Israel</option><option value="Italy">Italy</option><option value="Jamaica">Jamaica</option><option value="Japan">Japan</option><option value="Jordan">Jordan</option><option value="Kazakhstan">Kazakhstan</option><option value="Kenya">Kenya</option><option value="Kuwait">Kuwait</option><option value="Kyrgyzstan">Kyrgyzstan</option><option value="Laos">Laos</option><option value="Latvia">Latvia</option><option value="Lebanon">Lebanon</option><option value="Liberia">Liberia</option><option value="Lithuania">Lithuania</option><option value="Luxembourg">Luxembourg</option><option value="Macedonia">Macedonia</option><option value="Madagascar">Madagascar</option><option value="Malawi">Malawi</option><option value="Malaysia">Malaysia</option><option value="Malta">Malta</option><option value="Marshall_Islands">Marshall Islands</option><option value="Mauritius">Mauritius</option><option value="Mexico">Mexico</option><option value="Monaco">Monaco</option><option value="Mongolia">Mongolia</option><option value="Morocco">Morocco</option><option value="Mozambique">Mozambique</option><option value="Myanmar">Myanmar</option><option value="Namibia">Namibia</option><option value="Nepal">Nepal</option><option value="Netherlands">Netherlands</option><option value="New_Caledonia">New Caledonia</option><option value="New_Zealand">New Zealand</option><option value="Nicaragua">Nicaragua</option><option value="Nigeria">Nigeria</option><option value="Norway">Norway</option><option value="Oman">Oman</option><option value="Pakistan">Pakistan</option><option value="Panama">Panama</option><option value="Papua_New_Guinea">Papua New Guinea</option><option value="Paraguay">Paraguay</option><option value="Peru">Peru</option><option value="Philippines">Philippines</option><option value="Poland">Poland</option><option value="Portugal">Portugal</option><option value="Qatar">Qatar</option><option value="Romania">Romania</option><option value="Russia">Russia</option><option value="Saudi_Arabia">Saudi Arabia</option><option value="Senegal">Senegal</option><option value="Serbia_Montenegro">Serbia Montenegro</option><option value="Seychelles">Seychelles</option><option value="Singapore">Singapore</option><option value="Slovakia">Slovakia</option><option value="Slovenia">Slovenia</option><option value="South_Africa">South Africa</option><option value="South_Korea">South Korea</option><option value="Spain">Spain</option><option value="Sri_Lanka">Sri Lanka</option><option value="Sudan">Sudan</option><option value="Suriname">Suriname</option><option value="Sweden">Sweden</option><option value="Switzerland">Switzerland</option><option value="Syria">Syria</option><option value="Tahiti">Tahiti</option><option value="Taiwan">Taiwan</option><option value="Tanzania">Tanzania</option><option value="Thailand">Thailand</option><option value="Trinidad_and_Tobago">Trinidad and Tobago</option><option value="Tunisia">Tunisia</option><option value="Turkey">Turkey</option><option value="UAE">UAE</option><option value="Uganda">Uganda</option><option value="Ukraine">Ukraine</option><option value="United_Kingdom">United Kingdom</option><option value="United_States">United States</option><option value="Uruguay">Uruguay</option><option value="Uzbekistan">Uzbekistan</option><option value="Venezuela">Venezuela</option><option value="Vietnam">Vietnam</option><option value="Yemen">Yemen</option><option value="Zambia">Zambia</option><option value="Zimbabwe">Zimbabwe</option>
                                    </select>
                            </select>
                            <div id="select-ciudades"></div>
                         
                        </form>
                    </div>
                </li>
                <li>
                    <a class="uk-accordion-title" style="background-color:rgb(60, 61, 61);padding: 0.5em;width: 85%;">Item en desarrollo</a>
                    <div class="uk-accordion-content" >
                        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat proident.</p>
                    </div>
                </li>
            </ul>
            <button id="cerrar-aside" class="uk-offcanvas-close" type="button" uk-close></button>

        </div>
        
    </div>
   



    <div id="map"></div>
    <script>
        var map, marker;
        var nuevaLatitud, nuevaLongitud;
        var zoomy = 0.8

        function lista_xml() {
            document.getElementById('borrar_xml').style.display="block"
            var ubicaciones = JSON.parse('{{ lista | tojson | safe }}');
            if (screen.width < 1200) {
                    document.getElementById('cerrar-aside').click()
                }
            
            // Eliminar capas y fuentes existentes si las hay
            ['iss-points'].forEach(function(layer) {
                if (map.getLayer(layer)) map.removeLayer(layer);
                if (map.getSource(layer)) map.removeSource(layer);
            });

            // Crear array de coordenadas para los puntos
            var coordinates = ubicaciones.map(function(ubicacion) {
                return [parseFloat(ubicacion[1]), parseFloat(ubicacion[0])];
            }).filter(coord => !isNaN(coord[0]) && !isNaN(coord[1]));

            // Añadir la fuente y la capa de los puntos
            map.addSource('iss-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': coordinates.map(function(coord) {
                        return {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'Point',
                                'coordinates': coord
                            }
                        };
                    })
                }
            });

            map.addLayer({
                'id': 'iss-points',
                'type': 'circle',
                'source': 'iss-points',
                'paint': {
                    'circle-radius': 3,
                    'circle-color': '#ff0000',
                    'circle-opacity': 0.8
                }
            });

            // Ajustar la vista del mapa
            var bounds = coordinates.reduce(function(bounds, coord) {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

            map.fitBounds(bounds, {
                padding: 50,
                maxZoom: 15,
                duration: 2000
            });
        }

        function borrar_xml(){
              
              // Eliminar capas y fuentes existentes si las hay
              ['iss-points'].forEach(function(layer) {
                if (map.getLayer(layer)) map.removeLayer(layer);
                if (map.getSource(layer)) map.removeSource(layer);
            });
             document.getElementById('borrar_xml').style.display="none"
             if (screen.width < 1200) {
                    document.getElementById('cerrar-aside').click()
                }
        }

        function actualizarUbicacion() {
            fetch('/actualizar_ubicacion')
                .then(response => response.json())
                .then(data => {
                    if (data && data.latitud && data.longitud) {
                        nuevaLatitud = data.latitud;
                        nuevaLongitud = data.longitud;
                        document.getElementById('latitud').innerText = "Lat.: " + nuevaLatitud
                        document.getElementById('longitud').innerText = "Long: " + nuevaLongitud




                        // Crear y añadir el nuevo marcador
                        var el = document.createElement('div');
                        el.className = 'marker';

                        marker = new mapboxgl.Marker(el)
                            .setLngLat([nuevaLongitud, nuevaLatitud])
                            .addTo(map);

                        // Actualizar la vista del mapa
                        map.flyTo({
                            /*     center: [nuevaLongitud, nuevaLatitud], */
                            essential: true,
                            duration: 1000
                        });

                        console.log('Ubicación actualizada:', nuevaLatitud, nuevaLongitud);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function inicializarMapa() {
            var ubicacion = JSON.parse('{{ ubicacion | tojson | safe }}');
            mapboxgl.accessToken = 'pk.eyJ1IjoiZ2EtZWR1YXJkbyIsImEiOiJjbDVmNzQyY3kwaHJpM2pvM29lOWVuZnVlIn0.a20bgkRxwewC43RomqCQ9g';

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                center: [ubicacion[1], ubicacion[0]],
                zoom: zoomy,
                projection: 'globe'
            });

            marker = new mapboxgl.Marker()
                .setLngLat([ubicacion[1], ubicacion[0]])
                .addTo(map);

            map.on('zoom', function () {
                zoomy = map.getZoom();
                $("#sliderHandle").slider("value", zoomy);
                $("#custom-handle").text(zoomy.toFixed(1));
            });
        }





        function centrarMapa() {
            if (map && marker) {
                if (screen.width < 1200) {
                    document.getElementById('cerrar-aside').click()
                }
                map.flyTo({
                    center: [nuevaLongitud, nuevaLatitud],
                    zoom: zoomy,
                    duration: 1000,

                });
            }
        }

        function go_zoom() {
            if (map && marker) {

                map.flyTo({
                    /*   center: [nuevaLongitud, nuevaLatitud], */
                    zoom: zoomy,
                    speed: 0.2,

                });
            }
        }

        $(function () {
            var handle = $("#custom-handle");
            $("#sliderHandle").slider({
                range: 'min',
                min: 0,
                max: 23,
                values: 0,
                step: 1,
                create: function () {
                    handle.text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    handle.text(ui.value);
                    zoomy = ui.value
                    go_zoom()
                }
            });
        });



        document.addEventListener('DOMContentLoaded', inicializarMapa);
        // Volver a activar la actualización automática cada segundo
        setInterval(actualizarUbicacion, 1000);


        function limpiar_caja() {
            document.getElementById('caja-buscar').value = ""
            document.getElementById('caja-buscar').focus()

        }




    </script>
</body>

</html>